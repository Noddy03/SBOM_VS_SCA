name: Fetch, Trigger & Collect SBOM Scans

on:
  workflow_dispatch:

jobs:
  fetch_trigger_collect:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read

    steps:
      # -----------------------------
      # SETUP ENVIRONMENT
      # -----------------------------
      - name: Checkout this workflow repository
        uses: actions/checkout@v4

      - name: Setup jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Setup GitHub CLI
        uses: cli/cli-action@v2

      # -----------------------------
      # FETCH TOP PUBLIC REPOS
      # -----------------------------
      - name: Fetch top public repos
        run: |
          mkdir -p output
          curl -s https://raw.githubusercontent.com/your-org/top_public_repos/main/top_public_repos.json \
            -o output/top_public_repos.json
          echo "Top repos fetched:"
          cat output/top_public_repos.json

      # -----------------------------
      # TRIGGER SBOM SCAN WORKFLOW & COLLECT ARTIFACTS
      # -----------------------------
      - name: Trigger and collect SBOM scan workflow
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          # Read JSON array into Bash array
          mapfile -t repos_array < <(jq -r '.[]' output/top_public_repos.json)

          mkdir -p collected_artifacts

          for repo in "${repos_array[@]}"; do
            echo "Triggering SBOM scan for $repo..."

            # Trigger workflow and get run ID
            run_id=$(gh workflow run "Conan + Trivy Full SBOM Scan" \
              --ref main \
              -f src_repository="$repo" \
              -f src_branch="main" \
              --json number \
              | jq -r '.number')

            echo "Triggered workflow run ID: $run_id for $repo"

            # Wait for workflow to complete
            echo "Waiting for workflow $run_id to complete..."
            gh run wait $run_id

            # Download artifacts
            echo "Downloading artifacts for $repo..."
            gh run download $run_id --dir collected_artifacts/"$(echo $repo | tr '/' '_')"

            echo "Artifacts collected for $repo"
          done
