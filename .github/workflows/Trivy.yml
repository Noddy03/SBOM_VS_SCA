name: IOT_SBOM_SCA_Trivy

on:
  workflow_dispatch:
    inputs:
      language:
        description: "Language (e.g., Java, Python, C, C++)"
        required: true
        default: "Java"

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:

      - name: Cache Trivy DB
        uses: actions/cache@v3
        with:
          path: ~/.cache/trivy
          key: trivy-db

      - name: Fetch IoT Repos (limit to 10)
        run: |
          curl -s \
            "https://api.github.com/search/repositories?q=topic:iot+language:${{ github.event.inputs.language }}&sort=stars&order=desc&per_page=10" \
            | jq -r '.items[].clone_url' > repos.txt

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sudo sh -s -- -b /usr/local/bin

      - name: Prepare output
        run: |
          mkdir -p output
          echo "repo,sbom_components,sca_direct" > output/summary.csv

      - name: Process Each Repo (fast mode)
        run: |
          while IFS= read -r repo; do
            name=$(basename "$repo" .git)
            safe=$(echo "$name" | tr -cd 'A-Za-z0-9._-')

            echo "Cloning $repo"
            git clone --depth 1 "$repo" "$safe" || continue
            cd "$safe"

            sbom_file="../output/${safe}_sbom.json"
            sca_file="../output/${safe}_sca.json"

            # SBOM fast mode (no deep traversal)
            trivy fs \
              --depth 1 \
              --format cyclonedx \
              --output "$sbom_file" .

            sbom_components=$(jq '.components | length // 0' "$sbom_file")

            # SCA fast mode
            trivy fs \
              --depth 1 \
              --scanners vuln \
              --format json \
              --output "$sca_file" .

            sca_direct=$(jq '[.Results[].Vulnerabilities // [] | length] | add // 0' "$sca_file")

            echo "$safe,$sbom_components,$sca_direct" >> ../output/summary.csv

            cd ..
            rm -rf "$safe"
          done < repos.txt

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: iot_results
          path: output/
