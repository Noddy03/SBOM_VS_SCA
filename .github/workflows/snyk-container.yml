name: Security Scan – Trivy & SNYK (COMPILE + REAL JAVA SCA vs SBOM + Injected JAR)

on:
  workflow_dispatch:
    inputs:
      src_repository:
        description: 'Source Repository (e.g., user/repo)'
        required: true

permissions:
  contents: read

jobs:
  scan_repo:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq git curl unzip openjdk-17-jdk maven
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin
          curl -sSL https://static.snyk.io/cli/latest/snyk-linux -o snyk
          chmod +x snyk
          sudo mv snyk /usr/local/bin/snyk

      - name: Clone repo
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: git clone --depth 1 https://x-access-token:${TOKEN}@github.com/${{ inputs.src_repository }} project

      # 1️⃣ Trivy SCA sul codice sorgente (pre-compile)
      - name: Trivy SCA (source, pre-compile)
        run: |
          mkdir -p results
          trivy fs project --scanners vuln --format json --output results/trivy_sca_source.json || echo '{"Results":[]}' > results/trivy_sca_source.json

      # 2️⃣ Compila il progetto
      - name: Compile Java (best effort)
        run: |
          cd project
          if [ -f pom.xml ]; then
            mvn -DskipTests package || true
          fi

      # 3️⃣ Inject JAR vulnerabili nella cartella target/lib
      - name: Inject vulnerable JAR
        run: |
          cd project
          mkdir -p target/lib
          # Qui puoi scaricare o copiare JAR vulnerabili per simulazione
          # Esempio: curl -L <URL_JAR> -o target/lib/vuln-lib.jar
          echo "Simulazione JAR vulnerabile" > target/lib/fake-vuln.jar

      # 4️⃣ Trivy SCA sul codice compilato + librerie in target/lib
      - name: Trivy SCA (compiled, post-compile + injected JAR)
        run: |
          trivy fs project --scanners vuln --format json --output results/trivy_sca_compiled.json || echo '{"Results":[]}' > results/trivy_sca_compiled.json

      # 5️⃣ Trivy SBOM (post-compile + injected JAR)
      - name: Trivy SBOM
        run: |
          trivy fs project --format cyclonedx --scanners vuln,license --output results/sbom_Trivy.cdx.json || echo '{}' > results/sbom_Trivy.cdx.json
      - name: Trivy SBOM vulnerabilities
        run: |
          trivy sbom results/sbom_Trivy.cdx.json --scanners vuln --format json --output results/sbom_vuln_Trivy.json || echo '{"Results":[]}' > results/sbom_vuln_Trivy.json

      # 6️⃣ Snyk SCA e SBOM (post-compile)
      - name: Snyk SCA
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_SECRET }}
        run: |
          cd project
          snyk test --json > ../results/sca_raw_Snyk.json || true

      - name: Normalize Snyk
        run: |
          jq 'if type=="array" then map(.vulnerabilities // []) | add else .vulnerabilities // [] end' results/sca_raw_Snyk.json > results/sca_flat_Snyk.json || echo "[]" > results/sca_flat_Snyk.json
          jq '{vulnerabilities: . | unique_by(.id) | map({id,severity,title,package:.packageName,version,url})}' results/sca_flat_Snyk.json > results/sca_cleaned_Snyk.json

      - name: Snyk SBOM
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_SECRET }}
        run: |
          cd project
          snyk sbom --format=cyclonedx1.6-json --output=../results/sbom_Snyk.cdx.json || echo '{}' > ../results/sbom_Snyk.cdx.json

      # 7️⃣ Generate CSV summary of all CVEs
      - name: Build detailed summary.csv
        run: |
          echo "repo,tool,mode,severity,cve,package,version" > results/summary.csv
          R=$(echo "${{ inputs.src_repository }}" | sed 's#[/:]#_#g')    
          # Funzione helper per aggiungere CVE e stampare count
          add_cves() {
            local FILE=$1
            local TOOL=$2
            local MODE=$3
            local COUNT=$(jq '[.Results[]?.Vulnerabilities[]?] | length' "$FILE" 2>/dev/null || echo 0)
            jq -r --arg repo "$R" --arg tool "$TOOL" --arg mode "$MODE" \
              '.Results[]?.Vulnerabilities[]? | [$repo,$tool,$mode,.Severity,.VulnerabilityID,.PkgID,.InstalledVersion] | @csv' "$FILE" 2>/dev/null >> results/summary.csv || true
            echo "$TOOL $MODE CVE count: $COUNT"
          }      
          # Trivy SCA pre-compile
          add_cves results/trivy_sca_source.json "Trivy" "SCA pre-compile"
          # Trivy SCA post-compile
          add_cves results/trivy_sca_compiled.json "Trivy" "SCA post-compile"
          # Trivy SBOM
          add_cves results/sbom_vuln_Trivy.json "Trivy" "SBOM"      
          # Snyk SCA
          COUNT=$(jq '[.vulnerabilities[]?] | length' results/sca_cleaned_Snyk.json 2>/dev/null || echo 0)
          jq -r --arg repo "$R" '.vulnerabilities[]? | [$repo,"Snyk","SCA",(.severity // "unknown" | ascii_upcase),.id,(.package // "unknown"),(.version // "unknown")] | @csv' results/sca_cleaned_Snyk.json >> results/summary.csv
          echo "Snyk SCA CVE count: $COUNT"      
          # Snyk SBOM components (inventario, count può essere zero CVE)
          COUNT=$(jq '(.components // .bom.components // []) | length' results/sbom_Snyk.cdx.json 2>/dev/null || echo 0)
          jq -r --arg repo "$R" '(.components // .bom.components // [])[]? | [$repo,"Snyk","SBOM","NONE","",.name,(.version // "unknown")] | @csv' results/sbom_Snyk.cdx.json >> results/summary.csv
          echo "Snyk SBOM component count: $COUNT"      
          cat results/summary.csv


      # 8️⃣ Upload results
      - name: Set artifact name
        id: set_artifact
        run: |
          ARTIFACT_NAME=$(echo "${{ inputs.src_repository }}" | sed 's#[/:]#_#g')_$(date +%s)
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.set_artifact.outputs.artifact_name }}
          path: results
