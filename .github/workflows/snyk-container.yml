name: Security Scan – Trivy & SNYK (COMPILE + REAL JAVA SCA vs SBOM)

on:
  workflow_dispatch:
    inputs:
      src_repository:
        description: 'Source Repository (e.g., user/repo)'
        required: true

permissions:
  contents: read

jobs:
  scan_repo:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq git curl unzip openjdk-17-jdk maven
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin
          curl -sSL https://static.snyk.io/cli/latest/snyk-linux -o snyk
          chmod +x snyk
          sudo mv snyk /usr/local/bin/snyk

      - name: Clone repo
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: git clone --depth 1 https://x-access-token:${TOKEN}@github.com/${{ inputs.src_repository }} project

      # 1️⃣ Trivy SCA sul codice sorgente (prima della compilazione)
      - name: Trivy SCA (source, pre-compile)
        run: |
          mkdir -p results
          trivy fs project \
            --scanners vuln \
            --format json \
            --output results/trivy_sca_source.json || echo '{"Results":[]}' > results/trivy_sca_source.json
      
      # 2️⃣ Compila il progetto
      - name: Compile Java (best effort)
        run: |
          cd project
          if [ -f pom.xml ]; then
            mvn -DskipTests package || true
          fi
      
      # 3️⃣ Trivy SCA sul codice compilato
      - name: Trivy SCA (compiled, post-compile)
        run: |
          trivy fs project \
            --scanners vuln \
            --format json \
            --output results/trivy_sca_compiled.json || echo '{"Results":[]}' > results/trivy_sca_compiled.json
      
      # 4️⃣ Trivy SBOM (da compilato)
      - name: Trivy SBOM
        run: |
          trivy fs project \
            --format cyclonedx \
            --scanners vuln,license \
            --output results/sbom_Trivy.cdx.json || echo '{}' > results/sbom_Trivy.cdx.json
      - name: Trivy SBOM vulnerabilities
        run: |
          trivy sbom results/sbom_Trivy.cdx.json \
            --scanners vuln \
            --format json \
            --output results/sbom_vuln_Trivy.json || echo '{"Results":[]}' > results/sbom_vuln_Trivy.json
      
      # 5️⃣ Snyk SCA e SBOM possono rimanere uguali, ma ricordati:
      # Snyk SCA pre-compile vs post-compile
      # Snyk SBOM post-compile

      # ---------------- SNYK SCA ----------------
      - name: Snyk SCA (real Java)
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_SECRET }}
        run: |
          cd project
          snyk test --json > ../results/sca_raw_Snyk.json || true

      - name: Normalize Snyk
        run: |
          jq '
            if type=="array"
            then map(.vulnerabilities // []) | add
            else .vulnerabilities // []
            end
          ' results/sca_raw_Snyk.json > results/sca_flat_Snyk.json || echo "[]" > results/sca_flat_Snyk.json

          jq '
          {
            vulnerabilities:
              .
              | unique_by(.id)
              | map({
                  id,
                  severity,
                  title,
                  package: .packageName,
                  version: .version,
                  url
                })
          }
          ' results/sca_flat_Snyk.json > results/sca_cleaned_Snyk.json

      # ---------------- SNYK SBOM ----------------
      - name: Snyk SBOM
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_SECRET }}
        run: |
          cd project
          snyk sbom --format=cyclonedx1.6-json \
            --output=../results/sbom_Snyk.cdx.json || echo '{}' > ../results/sbom_Snyk.cdx.json

      # ---------------- SUMMARY CVE ----------------
      - name: Build detailed summary.csv
        run: |
          mkdir -p results
          echo "repo,tool,mode,severity,cve,package,version" > results/summary.csv    
          REPO_NAME=$(echo "${{ inputs.src_repository }}" | sed 's#[/:]#_#g')      
          # -------- TRIVY SCA pre-compile --------
          jq -r --arg repo "$REPO_NAME" '
            .Results[]?.Vulnerabilities[]? |
            [$repo,"Trivy","SCA pre-compile",.Severity,.VulnerabilityID,.PkgID,.InstalledVersion] |
            @csv
          ' results/trivy_sca_source.json 2>/dev/null >> results/summary.csv || true      
          # -------- TRIVY SCA post-compile --------
          jq -r --arg repo "$REPO_NAME" '
            .Results[]?.Vulnerabilities[]? |
            [$repo,"Trivy","SCA post-compile",.Severity,.VulnerabilityID,.PkgID,.InstalledVersion] |
            @csv
          ' results/trivy_sca_compiled.json 2>/dev/null >> results/summary.csv || true      
          # -------- TRIVY SBOM --------
          jq -r --arg repo "$REPO_NAME" '
            .Results[]?.Vulnerabilities[]? |
            [$repo,"Trivy","SBOM",.Severity,.VulnerabilityID,.PkgID,.InstalledVersion] |
            @csv
          ' results/sbom_vuln_Trivy.json 2>/dev/null >> results/summary.csv || true      
          # -------- SNYK SCA post-compile --------
          jq -r --arg repo "$REPO_NAME" '
            .vulnerabilities[]? |
            [$repo,"Snyk","SCA post-compile",
             (.severity // "unknown" | ascii_upcase),
             .id,
             (.package // "unknown"),
             (.version // "unknown")] |
            @csv
          ' results/sca_cleaned_Snyk.json 2>/dev/null >> results/summary.csv || true      
          # -------- SNYK SBOM --------
          jq -r --arg repo "$REPO_NAME" '
            (.components // .bom.components // [])[]? |
            [$repo,"Snyk","SBOM","NONE","",.name,(.version // "unknown")] |
            @csv
          ' results/sbom_Snyk.cdx.json 2>/dev/null >> results/summary.csv || true    
          cat results/summary.csv




      # ---------------- UPLOAD ----------------
      - name: Set artifact name
        id: set_artifact
        run: |
              ARTIFACT_NAME=$(echo "${{ inputs.src_repository }}" | sed 's#[/:]#_#g')_$(date +%s)
              echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
                
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
         name: ${{ steps.set_artifact.outputs.artifact_name }}
         path: results
