name: Top Repos Security Scan (Safe SBOM Discovery + Trivy + DepScan)

on:
  workflow_dispatch:
    inputs:
      language:
        description: Programming language (e.g. Java, Python)
        required: true
        default: "Java"
      top_n:
        description: Number of repos to scan
        required: false
        default: "5"

permissions:
  contents: read
  security-events: write

###############################################################################
# FETCH REPOS (SAFE, FAST, BOUNDED)
###############################################################################
jobs:
  fetch_repos:
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.fetch.outputs.repos }}
    steps:
      - name: Install prerequisites
        run: sudo apt-get update && sudo apt-get install -y python3 python3-pip curl jq

      - id: fetch
        env:
          LANG_FILTER: ${{ inputs.language }}
          TOP_N: ${{ inputs.top_n }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 <<'EOF'
          import os, requests, json, time, urllib.parse

          lang = os.environ["LANG_FILTER"].lower()
          top_n = int(os.environ["TOP_N"])
          token = os.environ["GITHUB_TOKEN"]

          headers = {
              "Authorization": f"token {token}",
              "Accept": "application/vnd.github+json"
          }

          repos = []
          per_page = 50
          max_pages = 10  # HARD STOP (500 repos max)

          def repo_has_required_files(owner, repo):
              # Get default branch
              r = requests.get(f"https://api.github.com/repos/{owner}/{repo}", headers=headers)
              if r.status_code != 200:
                  return False
              branch = r.json()["default_branch"]

              # Get full tree
              t = requests.get(
                  f"https://api.github.com/repos/{owner}/{repo}/git/trees/{branch}?recursive=1",
                  headers=headers
              )
              if t.status_code != 200:
                  return False

              paths = [x["path"].lower() for x in t.json().get("tree", [])]

              has_sbom = any("sbom.cdx.json" in p for p in paths)

              if lang == "java":
                  has_pom = any(p.endswith("pom.xml") for p in paths)
                  return has_sbom and has_pom

              return has_sbom

          for page in range(1, max_pages + 1):
              if len(repos) >= top_n:
                  break

              query = f"language:{lang}"
              url = (
                  f"https://api.github.com/search/repositories"
                  f"?q={urllib.parse.quote(query)}"
                  f"&sort=stars&order=desc&per_page={per_page}&page={page}"
              )

              res = requests.get(url, headers=headers)
              res.raise_for_status()

              for item in res.json().get("items", []):
                  full = item["full_name"]
                  owner, repo = full.split("/")

                  if repo_has_required_files(owner, repo):
                      repos.append(full)
                      print(f"âœ” accepted {full}")

                  if len(repos) >= top_n:
                      break

              time.sleep(1)

          print("FINAL REPOS:", repos)
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"repos={json.dumps(repos)}\n")
          EOF

      - name: Debug fetched repos
        run: echo "Fetched repos:${{ steps.fetch.outputs.repos }}"

###############################################################################
# SCAN REPOS
###############################################################################
  scan_repo:
    needs: fetch_repos
    if: ${{ needs.fetch_repos.outputs.repos != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJSON(needs.fetch_repos.outputs.repos) }}

    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq git unzip curl docker.io openjdk-17-jdk
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin

      - name: Clone repository
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git clone --depth 1 https://x-access-token:${TOKEN}@github.com/${{ matrix.repo }} project

      ###########################################################################
      # TRIVY FS SCA
      ###########################################################################
      - name: Trivy FS scan
        run: |
          mkdir -p results
          trivy fs project \
            --scanners vuln \
            --severity LOW,MEDIUM,HIGH,CRITICAL \
            --format json \
            --output results/trivy_fs.json || echo '{"Results":[]}' > results/trivy_fs.json

      ###########################################################################
      # SBOM + DEPSCAN
      ###########################################################################
      - name: SBOM + DepScan
        run: |
          mkdir -p results
          cd project
          trivy fs --format cyclonedx --output sbom.cdx.json . || true
          cd ..

          docker run --rm \
            -v "${{ github.workspace }}/project":/src \
            -v "${{ github.workspace }}/results":/results \
            owasp/dep-scan:latest scan \
            --input /src/sbom.cdx.json \
            --format json \
            --output /results/depscan.json || true

          jq -r '
            [.vulnerabilities[]? | .severity] | 
            {
              LOW: (map(select(.=="LOW"))|length),
              MEDIUM: (map(select(.=="MEDIUM"))|length),
              HIGH: (map(select(.=="HIGH"))|length),
              CRITICAL: (map(select(.=="CRITICAL"))|length)
            } | "\(.LOW),\(.MEDIUM),\(.HIGH),\(.CRITICAL)"
          ' results/depscan.json > results/sbom_counts.txt || echo "0,0,0,0" > results/sbom_counts.txt

      ###########################################################################
      # PACKAGE
      ###########################################################################
      - name: Package results
        run: |
          SAFE=$(echo '${{ matrix.repo }}' | tr '/' '-')
          zip -r "$SAFE.zip" results

      - uses: actions/upload-artifact@v4
        with:
          name: repo-results-${{ matrix.repo }}
          path: "*.zip"

###############################################################################
# SUMMARY
###############################################################################
  summarize:
    needs: scan_repo
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: all_results

      - name: Build summary.csv
        run: |
          echo "repo,sbom_low,sbom_medium,sbom_high,sbom_critical,total" > summary.csv
          for zip in all_results/**/*.zip; do
            REPO=$(basename "$zip" .zip)
            unzip -o "$zip" -d tmp >/dev/null
            IFS=',' read L M H C < tmp/results/sbom_counts.txt
            TOTAL=$((L+M+H+C))
            echo "$REPO,$L,$M,$H,$C,$TOTAL" >> summary.csv
            rm -rf tmp
          done

      - uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: summary.csv
