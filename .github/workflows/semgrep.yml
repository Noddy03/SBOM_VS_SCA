name: Multi-Repo Security Scan with SBOM

on:
  workflow_dispatch:
    inputs:
      language:
        description: "Programming language (e.g., java, python)"
        required: true
        default: 'java'
      top_n:
        description: "Number of top repos to scan"
        required: true
        default: '5'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  multi_repo_scan:
    runs-on: ubuntu-latest
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

    steps:
      # 1️⃣ Setup Python & Snyk CLI
      - name: Setup environment
        run: |
          python3 -m pip install --upgrade pip
          pip install semgrep jq requests

      - name: Setup Snyk CLI
        uses: snyk/actions/setup@v1
        with:
          snyk-version: latest

      # 2️⃣ Fetch top repos with SBOM
      - name: Fetch top repositories
        id: fetch_repos
        env:
          LANGUAGE: ${{ github.event.inputs.language }}
          TOP_N: ${{ github.event.inputs.top_n }}
        run: |
          echo "Fetching top $TOP_N repositories for language $LANGUAGE with SBOM..."
          REPOS=$(python3 - << 'EOF'
          import os, requests

          lang = os.environ.get('LANGUAGE', 'java')
          n = int(os.environ.get('TOP_N', 5))

          repos = []
          page = 1
          while len(repos) < n:
              url = f"https://api.github.com/search/repositories?q=language:{lang}+filename:sbom&type=Repositories&sort=stars&order=desc&per_page=100&page={page}"
              r = requests.get(url, headers={'Accept':'application/vnd.github+json'})
              r.raise_for_status()
              items = r.json().get('items', [])
              if not items:
                  break
              repos.extend([i['full_name'] for i in items])
              page += 1

          print(",".join(repos[:n]))
          EOF
          )
          echo "repos=$REPOS" >> $GITHUB_OUTPUT

      # 3️⃣ Scan each repo
      - name: Scan repositories
        run: |
          mkdir -p results
          echo "repo,low,medium,high,critical,total" > results/summary.csv
          IFS=',' read -r -a REPO_LIST <<< "${{ steps.fetch_repos.outputs.repos }}"
          for repo in "${REPO_LIST[@]}"; do
            echo "Scanning $repo ..."
            rm -rf project-src
            git clone --depth 1 "https://github.com/$repo" project-src || continue

            # Snyk SCA
            SCA_JSON="project-src/snyk-sca.json"
            snyk test project-src --all-projects --json > $SCA_JSON || echo '{"vulnerabilities":[]}' > $SCA_JSON

            # Snyk Code (SAST)
            SAST_SARIF="project-src/snyk-code.sarif"
            snyk code test project-src --all-projects --sarif-file=$SAST_SARIF || echo '{"version":"2.1.0","runs":[]}' > $SAST_SARIF

            # Semgrep
            SEMGREP_SARIF="project-src/semgrep.sarif"
            semgrep scan --config p/security-audit --lang ${{ github.event.inputs.language }} --sarif -o $SEMGREP_SARIF project-src || echo '{"version":"2.1.0","runs":[]}' > $SEMGREP_SARIF

            # Count vulnerabilities
            LOW=$(jq '[.vulnerabilities[] | select(.severity=="low")] | length' $SCA_JSON || echo 0)
            MEDIUM=$(jq '[.vulnerabilities[] | select(.severity=="medium")] | length' $SCA_JSON || echo 0)
            HIGH=$(jq '[.vulnerabilities[] | select(.severity=="high")] | length' $SCA_JSON || echo 0)
            CRITICAL=$(jq '[.vulnerabilities[] | select(.severity=="critical")] | length' $SCA_JSON || echo 0)
            TOTAL=$((LOW+MEDIUM+HIGH+CRITICAL))

            echo "\"$repo\",$LOW,$MEDIUM,$HIGH,$CRITICAL,$TOTAL" >> results/summary.csv

            # Save SARIF files for each repo
            mkdir -p results/$repo
            cp $SAST_SARIF results/$repo/ || true
            cp $SEMGREP_SARIF results/$repo/ || true
            cp $SCA_JSON results/$repo/ || true
          done

      # 4️⃣ Upload results
      - name: Upload scan results
        uses: actions/upload-artifact@v4
        with:
          name: multi-repo-security-results
          path: results
