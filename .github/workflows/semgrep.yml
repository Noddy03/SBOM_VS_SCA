name: Top Repos Security Scan (Snyk + Semgrep)

on:
  workflow_dispatch:
    inputs:
      language:
        description: "Programming language to filter repositories"
        required: true
        default: 'Java'
      top_n:
        description: "Number of top starred repositories to scan"
        required: false
        default: '20'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  full_scan:
    runs-on: ubuntu-latest
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

    steps:
      - name: Install required tools
        run: |
          sudo apt update && sudo apt install -y jq curl git
          python3 -m pip install --upgrade pip
          pip install semgrep

      - name: Fetch top repositories with SBOM
        id: fetch_repos
        run: |
          LANGUAGE="${{ github.event.inputs.language }}"
          TOP_N="${{ github.event.inputs.top_n }}"
          echo "Fetching top $TOP_N repositories for language $LANGUAGE with SBOM..."
          
          REPOS=$(curl -s "https://api.github.com/search/repositories?q=language:$LANGUAGE+stars:>0+filename:sbom.json&sort=stars&order=desc&per_page=$TOP_N" \
            | jq -r '.items[].full_name')
          
          if [ -z "$REPOS" ]; then
            echo "No repositories found with SBOM for language $LANGUAGE"
            echo "repo_list=[]" >> $GITHUB_OUTPUT
          else
            REPO_ARRAY=$(printf '%s\n' $REPOS | jq -R . | jq -s .)
            echo "repo_list=$REPO_ARRAY" >> $GITHUB_OUTPUT

      - name: Loop through repositories
        id: loop
        run: |
          REPOS=${{ steps.fetch_repos.outputs.repo_list }}
          echo "Scanning repositories: $REPOS"
          
          # Convert JSON array to bash array
          REPO_LIST=$(echo "$REPOS" | jq -r '.[]')
          echo "name,low,medium,high,critical,total" > summary.csv
          
          for repo in $REPO_LIST; do
            echo "Scanning $repo"
            git clone --depth 1 "https://github.com/$repo" project-src
            cd project-src || continue

            # Run Snyk SCA
            snyk test . --all-projects --json > snyk-sca.json || echo '{"vulnerabilities":[]}' > snyk-sca.json
            # Run Snyk Code
            snyk code test . --all-projects --sarif-file=snyk-code.sarif || echo '{"version":"2.1.0","runs":[]}' > snyk-code.sarif
            # Run Semgrep
            semgrep scan --config "p/security-audit" --sarif -o semgrep.sarif . || echo '{"version":"2.1.0","runs":[]}' > semgrep.sarif

            # Count vulnerabilities
            LOW=$(jq '[.vulnerabilities[] | select(.severity=="low")] | length' snyk-sca.json 2>/dev/null || echo 0)
            MEDIUM=$(jq '[.vulnerabilities[] | select(.severity=="medium")] | length' snyk-sca.json 2>/dev/null || echo 0)
            HIGH=$(jq '[.vulnerabilities[] | select(.severity=="high")] | length' snyk-sca.json 2>/dev/null || echo 0)
            CRITICAL=$(jq '[.vulnerabilities[] | select(.severity=="critical")] | length' snyk-sca.json 2>/dev/null || echo 0)

            # Include Snyk Code (map to severity)
            SAST_LOW=$(jq '[.runs[].results[] | select(.level=="note")] | length' snyk-code.sarif 2>/dev/null || echo 0)
            SAST_MEDIUM=$(jq '[.runs[].results[] | select(.level=="warning")] | length' snyk-code.sarif 2>/dev/null || echo 0)
            SAST_HIGH=$(jq '[.runs[].results[] | select(.level=="error")] | length' snyk-code.sarif 2>/dev/null || echo 0)
            SAST_CRITICAL=$(jq '[.runs[].results[] | select(.rule_id | test("critical"))] | length' snyk-code.sarif 2>/dev/null || echo 0)

            # Include Semgrep
            SEM_LOW=$(jq '[.runs[].results[] | select(.level=="INFO")] | length' semgrep.sarif 2>/dev/null || echo 0)
            SEM_MEDIUM=$(jq '[.runs[].results[] | select(.level=="WARNING")] | length' semgrep.sarif 2>/dev/null || echo 0)
            SEM_HIGH=$(jq '[.runs[].results[] | select(.level=="ERROR")] | length' semgrep.sarif 2>/dev/null || echo 0)
            SEM_CRITICAL=$(jq '[.runs[].results[] | select(.rule_id | test("critical|hardcoded|sql-injection|xss"))] | length' semgrep.sarif 2>/dev/null || echo 0)

            TOTAL=$((LOW+MEDIUM+HIGH+CRITICAL+SAST_LOW+SAST_MEDIUM+SAST_HIGH+SAST_CRITICAL+SEM_LOW+SEM_MEDIUM+SEM_HIGH+SEM_CRITICAL))

            echo "\"$repo\",$LOW,$MEDIUM,$HIGH,$CRITICAL,$TOTAL" >> ../summary.csv
            cd ..
            rm -rf project-src
          done

      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-summary
          path: summary.csv
