name: Security Scan â€“ Real SBOM + OSV SCA + Licenses

on:
  workflow_dispatch:
    inputs:
      language:
        description: 'Choose language to scan'
        required: true
        default: 'Java'
      top_n:
        description: 'Number of repositories to scan'
        required: false
        default: '5'

permissions:
  contents: read
  security-events: write

jobs:
# =========================================================
# FETCH REPOSITORIES
# =========================================================
  fetch_repos:
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.fetch.outputs.repos }}
    steps:
      - id: fetch
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LANG: ${{ inputs.language }}
          TOP_N: ${{ inputs.top_n }}
        run: |
          python3 <<'EOF'
          import os, requests, json, urllib.parse
          headers = {"Authorization": f"token {os.environ['TOKEN']}"}
          repos = []
          page = 1
          while len(repos) < int(os.environ["TOP_N"]):
              url = f"https://api.github.com/search/repositories?q=language:{urllib.parse.quote(os.environ['LANG'])}&sort=stars&order=desc&per_page=30&page={page}"
              r = requests.get(url, headers=headers)
              if r.status_code != 200: break
              for repo in r.json().get("items", []):
                  repos.append(repo["full_name"])
                  if len(repos) >= int(os.environ["TOP_N"]): break
              page += 1
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"repos={json.dumps(repos)}\n")
          EOF

# =========================================================
# SCAN REPOS
# =========================================================
  scan_repo:
    needs: fetch_repos
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJSON(needs.fetch_repos.outputs.repos) }}

    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq git curl unzip openjdk-17-jdk maven python3-pip golang
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin
          go install github.com/google/osv-scanner/cmd/osv-scanner@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Clone repo
        run: git clone --depth 1 https://github.com/${{ matrix.repo }} project

      - name: Create results dir
        run: mkdir -p results

      - name: Detect buildable repo
        id: detect
        run: |
          cd project
          if [ -f pom.xml ] || [ -f requirements.txt ] || [ -f pyproject.toml ]; then
            echo "buildable=true" >> $GITHUB_OUTPUT
          else
            echo "buildable=false" >> $GITHUB_OUTPUT
          fi


# ---------------- Build deps ----------------
      - name: Resolve dependencies
        if: steps.detect.outputs.buildable == 'true'
        run: |
          cd project
          if [ "${{ inputs.language }}" = "Java" ] && [ -f pom.xml ]; then
            mvn -B -q dependency:resolve
          fi
          if [ "${{ inputs.language }}" = "Python" ]; then
            python3 -m venv .venv
            source .venv/bin/activate
            pip install -q --upgrade pip
            if [ -f requirements.txt ]; then pip install -q -r requirements.txt; fi
            if [ -f pyproject.toml ]; then pip install -q .; fi
            deactivate
          fi


      # ---------------- REAL SBOM ----------------
      - name: Generate SBOM (Python deps)
        if: steps.detect.outputs.buildable == 'true' && inputs.language == 'Python'
        run: |
          cd project
          mkdir -p ../results
          source .venv/bin/activate
          trivy fs .venv --format cyclonedx --output ../results/sbom.cdx.json
          deactivate

      
      - name: Generate SBOM (Java deps)
        if: steps.detect.outputs.buildable == 'true' && inputs.language == 'Java'
        run: |
          cd project
          mkdir -p ../results
          mvn -q -DskipTests package
          trivy fs target --format cyclonedx --output ../results/sbom.cdx.json



      # ---------------- SCA FROM SBOM ----------------
      - name: OSV scan SBOM
        if: steps.detect.outputs.buildable == 'true'
        run: |
          osv-scanner --sbom results/sbom.cdx.json --format json > results/osv.json


# ---------------- LICENSES ----------------
      - name: License scan
        if: steps.detect.outputs.buildable == 'true'
        run: |
          trivy fs project --scanners license --format json > results/licenses.json


# ---------------- SUMMARY ----------------
      - name: Build summary
        if: steps.detect.outputs.buildable == 'true'
        run: |
          jq '[.results[].packages[].vulnerabilities[]?] 
              | unique_by(.id + .package.name) 
              | group_by(.database_specific.severity // "UNKNOWN") 
              | map({(.[0].database_specific.severity // "UNKNOWN"): length}) 
              | add' results/osv.json > results/vuln_counts.json


      - name: Set artifact name
        id: name
        run: |
          echo "artifact=$(echo "${{ matrix.repo }}" | tr '/' '_')" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        if: steps.detect.outputs.buildable == 'true'
        with:
          name: ${{ steps.name.outputs.artifact }}
          path: results


# =========================================================
# GLOBAL SUMMARY
# =========================================================
  build_summary:
    needs: scan_repo
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: all

      - name: Build CSV
        run: |
          echo "repo,low,medium,high,critical" > summary.csv
          for d in all/*; do
            R=$(basename "$d" | tr '_' '/')
            L=$(jq '.LOW // 0' "$d/vuln_counts.json")
            M=$(jq '.MEDIUM // 0' "$d/vuln_counts.json")
            H=$(jq '.HIGH // 0' "$d/vuln_counts.json")
            C=$(jq '.CRITICAL // 0' "$d/vuln_counts.json")
            echo "$R,$L,$M,$H,$C" >> summary.csv
          done

      - uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: summary.csv
