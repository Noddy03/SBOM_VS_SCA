name: Fetch Top IoT Repositories + Trivy/Conan SBOM Scan (NTIA + BSI V2)

on:
  workflow_dispatch:
    inputs:
      language:
        description: "Programming language to scan (e.g. C++, Python, Java)"
        required: true
        default: "C++"

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # ------------------------------------------------------------------
  # 1. Fetch top IoT repositories using GitHub API (stable version)
  # ------------------------------------------------------------------
  fetch_top_repos:
    name: Fetch top IoT repositories (${{ github.event.inputs.language }})
    runs-on: ubuntu-latest
    outputs:
      repo_list: ${{ steps.fetch.outputs.repo_list }}
    steps:
      - name: Install jq
        run: sudo apt-get update -y && sudo apt-get install -y jq

      - name: Fetch IoT repositories
        id: fetch
        env:
          LANG: ${{ github.event.inputs.language }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          RAW_Q="topic:IoT language:\"$LANG\" fork:false archived:false"

          REPOS=$(gh api -X GET /search/repositories \
            --raw-field q="$RAW_Q" \
            --raw-field sort=stars \
            --raw-field order=desc \
            --raw-field per_page=30 \
            --jq '.items[].full_name'
          )

          echo "Found repos:"
          echo "$REPOS"

          JSON_ARRAY=$(echo "$REPOS" | jq -R -s -c 'split("\n")[:-1]')

          # Important: wrap JSON in quotes so GitHub accepts it
          echo "repo_list=\"$JSON_ARRAY\"" >> $GITHUB_OUTPUT


  # ------------------------------------------------------------------
  # 2. SBOM Scan (matrix)
  # ------------------------------------------------------------------
  sbom_scan:
    name: SBOM Scan for ${{ matrix.repo }}
    runs-on: ubuntu-latest
    needs: fetch_top_repos

    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJson(needs.fetch_top_repos.outputs.repo_list) }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repo }}
          path: project-src

      - name: Install Conan & Trivy & jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y pipx jq
          pipx install conan
          sudo apt-get install -y trivy

      # --------------------------------------------------------------
      # GitHub API License Fetch
      # --------------------------------------------------------------
      - name: Fetch license via GitHub API
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          OWNER=$(echo "${{ matrix.repo }}" | cut -d/ -f1)
          REPO=$(echo "${{ matrix.repo }}" | cut -d/ -f2)

          gh api repos/$OWNER/$REPO/license \
            --jq '{license: (.license | {id: .spdx_id})}' \
            > project-src/license.json || echo '{}' > project-src/license.json

      # --------------------------------------------------------------
      # Conan SBOM
      # --------------------------------------------------------------
      - name: Generate Conan SBOM (CycloneDX)
        working-directory: project-src
        run: |
          conan profile detect || true

          conan install . --build=missing || true

          conan sbom . --format cyclonedx-json --output conan-sbom.json || \
            echo '{"components":[]}' > conan-sbom.json

      # --------------------------------------------------------------
      # Trivy SBOM
      # --------------------------------------------------------------
      - name: Generate Trivy SBOM (CycloneDX)
        run: |
          trivy fs project-src --format cyclonedx --output project-src/trivy.json || \
            echo '{"components":[]}' > project-src/trivy.json

      # --------------------------------------------------------------
      # SAFE SBOM MERGE (no Python, no huge variables, no jq errors)
      # --------------------------------------------------------------
      - name: Merge Conan + Trivy + License into merged.json
        run: |
          # Normalize missing license
          jq '.license // {"id":"NOASSERTION"}' project-src/license.json \
            > project-src/license_norm.json

          jq -n \
            --slurpfile trivy project-src/trivy.json \
            --slurpfile conan project-src/conan-sbom.json \
            --slurpfile lic project-src/license_norm.json \
            '
            {
              "bomFormat":"CycloneDX",
              "specVersion":"1.5",
              "version":1,
              "components":
                (
                  ($trivy[0].components // [])
                  +
                  ($conan[0].components // [])
                | map(.licenses = (.licenses // [ { "license": $lic[0] } ]))
                )
            }
            ' > project-src/merged.json

      # --------------------------------------------------------------
      # Upload artifacts
      # --------------------------------------------------------------
      - name: Upload merged SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ matrix.repo }}.json
          path: project-src/merged.json
