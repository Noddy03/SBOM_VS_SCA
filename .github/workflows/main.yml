name: Fetch Top IoT Repositories + Full SBOM Merge (NTIA + BSI V2)

on:
  workflow_dispatch:
    inputs:
      language:
        description: "Programming language to scan (C++, Python, Java, etc.)"
        required: true
        default: "C++"

permissions:
  contents: read
  security-events: write
  actions: read

jobs:

  # ------------------------------------------------------------------
  # 1. Fetch Top IoT Repositories
  # ------------------------------------------------------------------
  fetch_top_repos:
    name: Fetch top 50 IoT repositories
    runs-on: ubuntu-latest

    outputs:
      repo_list: ${{ steps.fetch.outputs.repo_list }}

    steps:
      - name: Install jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Fetch top IoT repos
        id: fetch
        env:
          LANG: ${{ github.event.inputs.language }}
          GH_TOKEN: ${{ github.token }}   # <-- FIXED
        run: |
          set -euo pipefail
          RAW_Q="topic:IoT language:\"$LANG\" fork:false archived:false"

          echo "ðŸ” Query: $RAW_Q"
          REPOS=$(gh api -X GET /search/repositories \
              --raw-field q="$RAW_Q" \
              --raw-field sort=stars \
              --raw-field order=desc \
              --raw-field per_page=50 \
              --jq '.items[].full_name'
          )

          JSON=$(echo "$REPOS" | jq -R -s -c 'split("\n")[:-1]')
          echo "repo_list=$JSON" >> $GITHUB_OUTPUT


  # ------------------------------------------------------------------
  # 2. SCAN + MERGE SBOMS (Option A)
  # ------------------------------------------------------------------
  sbom_scan:
    name: Full SBOM Scan + Merge (Conan + Trivy + GitHub License)
    needs: fetch_top_repos
    runs-on: ubuntu-latest
    continue-on-error: true

    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJSON(needs.fetch_top_repos.outputs.repo_list) }}

    steps:
      - name: Install prerequisites
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq python3-pip coreutils uuid-runtime curl
          pip install conan cyclonedx-bom

      # ----------------------------------------------
      # Checkout repo (retry-safe)
      # ----------------------------------------------
      - name: Checkout repository
        id: checkout
        env:
          REPO: ${{ matrix.repo }}
          TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          if git clone --depth=1 "https://$TOKEN@github.com/$REPO" project-src; then
            echo "skip_repo=false" >> $GITHUB_ENV
          else
            echo "skip_repo=true" >> $GITHUB_ENV
          fi

      # ----------------------------------------------
      # 2.1 Extract GitHub License (repo-level license)
      # ----------------------------------------------
      - name: Fetch GitHub license
        if: env.skip_repo != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ matrix.repo }}
        run: |
          gh api repos/$REPO/license --jq '{license:{id:.license.spdx_id}}' \
            > project-src/license-github.json || echo '{"license":{"id":"NOASSERTION"}}' > project-src/license-github.json

      # ----------------------------------------------
      # 2.2 Conan SBOM (dependencies)
      # ----------------------------------------------
      - name: Generate Conan SBOM (CycloneDX)
        if: env.skip_repo != 'true'
        run: |
          cd project-src || exit 0
          conan profile detect --force || true
          conan install . --output-folder=build --build=missing || true
          conan graph info . --format=json > conan-graph.json || true
          cyclonedx-bom -i conan-graph.json -o conan-sbom.json || echo '{"bomFormat":"CycloneDX","specVersion":"1.5","version":1,"components":[]}' > conan-sbom.json

      # ----------------------------------------------
      # 2.3 Trivy FS scan (license + vulnerabilities)
      # ----------------------------------------------
      - name: Run Trivy CycloneDX SBOM scan
        if: env.skip_repo != 'true'
        uses: aquasecurity/trivy-action@0.25.0
        with:
          scan-type: fs
          scan-ref: ./project-src
          format: cyclonedx
          scanners: vuln,license
          output: project-src/trivy-fs.json
          ignore-unfixed: true
          severity: CRITICAL,HIGH,MEDIUM

      # ----------------------------------------------
      # 2.4 Merge all SBOMs (Option A)
      # ----------------------------------------------
      - name: Merge SBOMs (Conan + Trivy FS + GitHub License)
        if: env.skip_repo != 'true'
        run: |
          python3 << 'EOF'
            import json, os, uuid

            def load(path):
            try:
              return json.load(open(path))
            except:
              return {"components": []}

            trivy = load("project-src/trivy-fs.json")
            conan = load("project-src/conan-sbom.json")
            gh_license = load("project-src/license-github.json")

            merged = {
              "bomFormat": "CycloneDX",
              "specVersion": "1.5",
              "version": 1,
              "metadata": trivy.get("metadata", {}),
              "components": []
              }

            def normalize(comps):
            out = []
            if not isinstance(comps, list):
                return out
            for c in comps:
              if not isinstance(c, dict):
                  continue
              if "licenses" not in c:
                  c["licenses"] = [gh_license.get("license", {"id": "NOASSERTION"})]
              if "bom-ref" not in c:
                  c["bom-ref"] = str(uuid.uuid4())
              out.append(c)
            return out

            merged["components"] += normalize(trivy.get("components", []))
            merged["components"] += normalize(conan.get("components", []))

            with open("project-src/merged-sbom.json", "w") as f:
            json.dump(merged, f, indent=2)
          EOF
