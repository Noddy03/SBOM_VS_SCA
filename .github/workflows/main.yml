name: Fetch Top IoT Repositories + Trivy/Conan SBOM Scan (NTIA + BSI V2)

on:
  workflow_dispatch:
    inputs:
      language:
        description: "Programming language to scan (e.g. C++, Python, Java)"
        required: true
        default: "C++"

permissions:
  contents: read
  security-events: write
  actions: read

jobs:

  # ---------------------------------------------------------
  # 1. FETCH TOP IoT REPOSITORIES
  # ---------------------------------------------------------
  fetch_top_repos:
    runs-on: ubuntu-latest
    outputs:
      repo_list: ${{ steps.fetch.outputs.repo_list }}

    steps:
      - name: Install jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Fetch top IoT repositories (topic:IoT)
        id: fetch
        env:
          LANG: ${{ github.event.inputs.language }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          echo "ðŸ”Ž Searching IoT repos in language: $LANG"

          RAW_Q="topic:IoT language:\"$LANG\" fork:false archived:false"

          REPOS=$(gh api -X GET /search/repositories \
            --raw-field q="$RAW_Q" \
            --raw-field sort=stars \
            --raw-field order=desc \
            --raw-field per_page=40 \
            --jq '.items[].full_name'
          )

          echo "Found repos:"
          echo "$REPOS"

          # Convert to JSON array â€” must NOT be double-quoted
          JSON_ARRAY=$(jq -R -s -c 'split("\n")[:-1]' <<< "$REPOS")

          echo "repo_list=$JSON_ARRAY" >> $GITHUB_OUTPUT

  # ---------------------------------------------------------
  # 2. SBOM SCAN PER REPO
  # ---------------------------------------------------------
  sbom_scan:
    needs: fetch_top_repos
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJson(needs.fetch_top_repos.outputs.repo_list) }}

    steps:
      - name: Install prerequisites
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq python3-pip
          pip install conan

      - name: Checkout repo
        env:
          TOKEN: ${{ github.token }}
        run: |
          git clone --depth=1 "https://$TOKEN@github.com/${{ matrix.repo }}" project-src

      # -------------------------
      # GitHub API license fetch
      # -------------------------
      - name: Fetch GitHub License
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api repos/${{ matrix.repo }}/license > project-src/license.json || echo '{}' > project-src/license.json

      # -------------------------
      # Conan SBOM
      # -------------------------
      - name: Conan Profile Detect
        run: conan profile detect --force || true

      - name: Generate Conan SBOM
        continue-on-error: true
        run: |
          conan graph info project-src --format=json > project-src/conan-info.json || echo '{}' > project-src/conan-info.json
          jq -n --arg repo "${{ matrix.repo }}" '
            {
              "components":[
                {
                  "name":$repo,
                  "type":"application",
                  "licenses":[{"license":{"id":"NOASSERTION"}}]
                }
              ]
            }' > project-src/conan-sbom.json

      # -------------------------
      # Trivy SBOM (CycloneDX)
      # -------------------------
      - name: Trivy SBOM
        uses: aquasecurity/trivy-action@0.25.0
        with:
          scan-type: fs
          scan-ref: ./project-src
          scanners: vuln,license
          format: cyclonedx
          output: project-src/trivy.json
          ignore-unfixed: true

      # -------------------------
      # Merge SBOMs (NO PYTHON)
      # -------------------------
      - name: Merge Conan + Trivy + GitHub license (pure jq)
        run: |
          LICENSE=$(jq -c '.license // {"id":"NOASSERTION"}' project-src/license.json)
          
          # Ensure components exist
          TRIVY_COMPS=$(jq -c '.components // []' project-src/trivy.json)
          CONAN_COMPS=$(jq -c '.components // []' project-src/conan-sbom.json)

          jq -n \
            --argjson trivy "$TRIVY_COMPS" \
            --argjson conan "$CONAN_COMPS" \
            --argjson lic "$LICENSE" \
          '
          {
            "bomFormat":"CycloneDX",
            "specVersion":"1.5",
            "version":1,
            "metadata":{},
            "components":
              ($trivy + $conan | map(.licenses = (.licenses // [ { "license": $lic } ])))
          }
          ' > project-src/merged.json

      # -------------------------
      # SBOMQS
      # -------------------------
      - name: NTIA Compliance
        run: |
          docker run --rm -v $PWD/project-src:/sbom \
            ghcr.io/interlynk-io/sbomqs:latest \
            compliance --ntia /sbom/merged.json > project-src/NTIA.json || true

      - name: BSI V2 Compliance
        run: |
          docker run --rm -v $PWD/project-src:/sbom \
            ghcr.io/interlynk-io/sbomqs:latest \
            compliance --bsi-v2 /sbom/merged.json > project-src/BSI.json || true

      - name: Score
        run: |
          docker run --rm -v $PWD/project-src:/sbom \
            ghcr.io/interlynk-io/sbomqs:latest \
            score /sbom/merged.json --json > project-src/score.json || true

      # -------------------------
      # Upload artifacts
      # -------------------------
      - name: Safe repo name
        run: |
          SAFE="${{ matrix.repo }}"
          SAFE="${SAFE//\//_}"
          echo "SAFE=$SAFE" >> $GITHUB_ENV

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ env.SAFE }}
          path: project-src/*.json

  # ---------------------------------------------------------
  # 3. AGGREGATE (NO PYTHON)
  # ---------------------------------------------------------
  aggregate_results:
    needs: sbom_scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: results/

      - name: Create CSV (NO PYTHON)
        run: |
          echo "repository,standard,message" > sbomqs_summary.csv
          for f in $(find results -name "*.json"); do
            repo=$(basename "$(dirname "$f")")
            if [[ "$f" == *NTIA.json ]]; then
              std="NTIA"
            elif [[ "$f" == *BSI.json ]]; then
              std="BSI"
            elif [[ "$f" == *score.json ]]; then
              std="SCORE"
            else
              std="UNKNOWN"
            fi
            msg=$(jq -r 'tostring' "$f")
            echo "$repo,$std,$msg" >> sbomqs_summary.csv
          done

      - name: Upload summary CSV
        uses: actions/upload-artifact@v4
        with:
          name: sbomqs_summary
          path: sbomqs_summary.csv
