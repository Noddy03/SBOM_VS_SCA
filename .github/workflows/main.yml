name: IoT Repository Scanner â€“ Conan SBOM + Trivy + GitHub License

on:
  workflow_dispatch:
    inputs:
      language:
        description: "Programming language to scan (C++, Python, Java, etc.)"
        required: true
        default: "C++"

permissions:
  contents: read
  actions: read
  security-events: write

jobs:

  # -------------------------------------------------------------
  # 1. FETCH TOP IoT REPOSITORIES
  # -------------------------------------------------------------
  fetch_repos:
    runs-on: ubuntu-latest
    outputs:
      repo_list: ${{ steps.collect.outputs.repo_list }}

    steps:
      - name: Install jq
        run: sudo apt-get update -y && sudo apt-get install -y jq

      - name: Collect top repositories
        id: collect
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LANG="${{ inputs.language }}"
          QUERY="topic:IoT language:\"$LANG\" fork:false archived:false"

          # Fetch top 20 repos
          gh search repos "$QUERY" --limit 20 --json fullName \
            | jq -r '.[].fullName' > repos.txt

          # Convert to SINGLE-LINE JSON ARRAY
          JSON=$(jq -Rc 'split("\n")[:-1]' repos.txt)

          echo "repo_list=$JSON" >> $GITHUB_OUTPUT


  # -------------------------------------------------------------
  # 2. SCAN + SBOM + LICENSES
  # -------------------------------------------------------------
  scan:
    needs: fetch_repos
    runs-on: ubuntu-latest
    continue-on-error: true

    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJson(needs.fetch_repos.outputs.repo_list) }}

    steps:

      - name: Prepare system
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl python3-pip
          pip install conan

      - name: Checkout repository
        env:
          TOKEN: ${{ github.token }}
        run: |
          git clone --depth=1 https://$TOKEN@github.com/${{ matrix.repo }} repo \
            || echo "clone_failed=true" >> $GITHUB_ENV

      - name: Skip if clone failed
        if: env.clone_failed == 'true'
        run: exit 0

      # -----------------------------------------------------------
      # CONAN SBOM
      # -----------------------------------------------------------
      - name: Conan detect
        run: conan profile detect --force || true

      - name: Generate Conan SBOM
        run: |
          cd repo
          conan graph info . --format=json > ../conan-sbom.json || echo '{"components":[]}' > ../conan-sbom.json

      # -----------------------------------------------------------
      # TRIVY ANALYSIS OF SBOM (LICENSE + VULN)
      # -----------------------------------------------------------
      - name: Install Trivy
        run: |
          curl -L https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -

      - name: Analyze SBOM using Trivy
        run: |
          ./trivy sbom conan-sbom.json \
            --format cyclonedx \
            --scanners vuln,license \
            --output trivy-sbom.json \
            || echo '{"components":[]}' > trivy-sbom.json

      # -----------------------------------------------------------
      # GITHUB API LICENSE FOR MAIN REPO
      # -----------------------------------------------------------
      - name: Fetch GitHub license of repo
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          OWNER=$(echo "${{ matrix.repo }}" | cut -d'/' -f1)
          NAME=$(echo "${{ matrix.repo }}" | cut -d'/' -f2)

          gh api repos/$OWNER/$NAME/license \
            --jq '{license: .license.spdx_id}' > gh-license.json \
            || echo '{"license":"NOASSERTION"}' > gh-license.json

      # -----------------------------------------------------------
      # CREATE FINAL MERGED SBOM WITHOUT PYTHON
      # -----------------------------------------------------------
      - name: Create merged SBOM (Bash-only)
        run: |
          SPDX=$(jq -r '.license' gh-license.json)

          jq --arg spdx "$SPDX" '
            .components |= map(
              if (.licenses | length == 0) then
                .licenses = [{"license":{"id":$spdx}}]
              else .
              end
            )
          ' trivy-sbom.json > merged-sbom.json

      # -----------------------------------------------------------
      # SBOMQS CHECKS
      # -----------------------------------------------------------
      - name: SBOMQS NTIA
        run: |
          docker run --rm -v $PWD:/sbom ghcr.io/interlynk-io/sbomqs:latest \
            compliance --ntia /sbom/merged-sbom.json \
            > compliance_NTIA.json || true

      - name: SBOMQS BSI
        run: |
          docker run --rm -v $PWD:/sbom ghcr.io/interlynk-io/sbomqs:latest \
            compliance --bsi-v2 /sbom/merged-sbom.json \
            > compliance_BSI.json || true

      - name: SBOMQS Score
        run: |
          docker run --rm -v $PWD:/sbom ghcr.io/interlynk-io/sbomqs:latest \
            score /sbom/merged-sbom.json --json \
            > score.json || true

      # -----------------------------------------------------------
      # Upload artifacts
      # -----------------------------------------------------------
      - name: Safe repo name
        run: |
          SAFE="${{ matrix.repo }}"
          SAFE="${SAFE//\//_}"
          echo "SAFE=$SAFE" >> $GITHUB_ENV

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ env.SAFE }}
          path: |
            merged-sbom.json
            compliance_*.json
            score.json


  # -------------------------------------------------------------
  # 3. AGGREGATE RESULTS INTO CSV (NO PYTHON)
  # -------------------------------------------------------------
  aggregate:
    needs: scan
    runs-on: ubuntu-latest

    steps:

      - uses: actions/download-artifact@v4
        with:
          path: results/

      - name: Create CSV without Python
        run: |
          echo "repository,file,status" > sbom-summary.csv

          for repo in results/*; do
            r=$(basename "$repo")
            for file in "$repo"/*.json; do
              f=$(basename "$file")
              echo "$r,$f,OK" >> sbom-summary.csv
            done
          done

      - uses: actions/upload-artifact@v4
        with:
          name: sbom-summary
          path: sbom-summary.csv
