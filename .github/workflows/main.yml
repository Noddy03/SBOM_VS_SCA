name: IoT SBOM Pipeline

on:
  workflow_dispatch:
    inputs:
      language:
        description: "Language to search (e.g., C++)"
        required: true
        default: "C++"

jobs:
  generate-sboms:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Tools
      run: |
        sudo apt-get update -y
        sudo apt-get install -y jq wget
        wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_Linux-64bit.deb
        sudo dpkg -i trivy_Linux-64bit.deb

    - name: Search IoT Repositories
      id: search
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        QUERY="topic:IoT language:\"${{ inputs.language }}\" fork:false archived:false"
        echo "ðŸ” GitHub Search Query: $QUERY"

        REPOS=$(gh api /search/repositories \
          --raw-field q="$QUERY" \
          --raw-field sort="stars" \
          --raw-field order="desc" \
          --raw-field per_page="50" \
          --jq '.items[].full_name')

        if [ -z "$REPOS" ]; then
          echo "No repos found."
          exit 1
        fi

        JSON=$(echo "$REPOS" | jq -R -s -c 'split("\n")[:-1]')
        echo "repo_list=$JSON" >> "$GITHUB_OUTPUT"

    - name: Process and Enrich Repos
      run: |
        mkdir -p project-src sbom-results sbom-reports sbom-pdf

        mapfile -t REPOS < <(echo '${{ steps.search.outputs.repo_list }}' | jq -r '.[]')

        for REPO in "${REPOS[@]}"; do
          echo "ðŸ“¦ Processing $REPO..."

          SAFE_REPO_NAME=$(echo "$REPO" | tr '/' '_')

          git clone --depth 1 "https://github.com/$REPO.git" project-src

          trivy fs project-src \
            --format cyclonedx \
            --license-full \
            --scanners vuln,secret,license,misconfig \
            --output "project-src/trivy-report.json"

          ##########################################
          # BULLETPROOF COMPONENT NORMALIZER
          ##########################################
          jq '
            .components = (
              .components
              // []
              | (if type=="object" and has("components") then .components else . end)
              | (if type=="array" then . else [.] end)
              | map(if type=="array" then .[] else . end)
              | map(if type=="object" then . else {"name": tostring, "type":"library"} end)
            )
          ' project-src/trivy-report.json > tmp && mv tmp project-src/trivy-report.json

          ##########################################
          # ENRICH SBOM (FULL NTIA + BSI + CYCLOENDX 1.5)
          ##########################################
          jq '
            .bomFormat="CycloneDX" |
            .specVersion="1.5" |

            .metadata |= (
              (.authors = (if .authors|type!="array" then [] else . end)) +
              { authors: (.authors + [{"name":"Automated SBOM Enrichment (Interlynk/Trivy)"}]) }
            ) |

            .metadata.properties += [
              {"name":"sbom_author","value":"Automated SBOM Enrichment (Interlynk/Trivy)"}
            ] |

            .components |= map(
              . as $c
              | $c + {
                  hashes: (
                    ($c.hashes // [])
                    + [ { "alg": "SHA-256",
                          "content": ($c.name + ":" + ($c.version // "NO_VERSION") | @sha256) } ]
                  ),

                  externalReferences: (
                    ($c.externalReferences // [])
                    + (if ($c.purl? // "") != ""
                       then [{"type":"vcs","url":("https://repo.url/" + ($c.name // ""))}]
                       else [] end)
                  ),

                  properties: (
                    ($c.properties // [])
                    + [
                        {"name":"enriched","value":"true"},
                        {"name":"enriched_by","value":"GitHub Actions SBOM Pipeline"},
                        {"name":"enriched_date","value":(now | todate)}
                      ]
                  ),

                  licenses: (
                    if ($c.licenses? | type=="array") then $c.licenses
                    elif ($c.licenses? | type=="object") then [$c.licenses]
                    else [{"license":{"id":"NOASSERTION"}}]
                    end
                  )
                }
            )
          ' project-src/trivy-report.json > tmp && mv tmp project-src/trivy-report.json

          cp project-src/trivy-report.json "sbom-results/${SAFE_REPO_NAME}.json"

          ##########################################
          # PDF GENERATION
          ##########################################
          docker run --rm \
            -v "$PWD/sbom-results:/work" \
            ghcr.io/interlynk-io/sbomqs:latest \
            pdf -i "/work/${SAFE_REPO_NAME}.json" -o "/work/${SAFE_REPO_NAME}.pdf"

          mv "sbom-results/${SAFE_REPO_NAME}.pdf" "sbom-pdf/${SAFE_REPO_NAME}.pdf"

          rm -rf project-src/*
        done

    - name: Aggregate SBOM JSON
      run: |
        jq -s '{bomFormat:"CycloneDX", specVersion:"1.5", components:(map(.components) | add)}' sbom-results/*.json \
          > sbom-reports/aggregated.json

    - name: Aggregate SBOM PDF
      run: |
        docker run --rm \
          -v "$PWD/sbom-reports:/work" \
          ghcr.io/interlynk-io/sbomqs:latest \
          pdf -i "/work/aggregated.json" -o "/work/aggregated.pdf"

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sbom-bundle
        path: |
          sbom-results
          sbom-reports
          sbom-pdf
