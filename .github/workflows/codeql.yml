name: IoT CodeQL + Semgrep Multi-Repo Scan

on:
  workflow_dispatch:
    inputs:
      language:
        description: "Primary language to scan (e.g., python, cpp, java, javascript)"
        required: true
        default: "python"

permissions:
  contents: read
  security-events: write
  actions: read
  packages: read

jobs:

  fetch_top_repos:
    runs-on: ubuntu-latest
    outputs:
      repo_list: ${{ steps.fetch.outputs.repo_list }}
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq gh git

      - name: Fetch top IoT repositories
        id: fetch
        env:
          LANG: ${{ github.event.inputs.language }}
          GH_TOKEN: ${{ github.token }}
        run: |
          RAW_Q="topic:iot language:$LANG fork:false archived:false"
          REPOS=$(gh api -X GET /search/repositories \
            --raw-field q="$RAW_Q" \
            --raw-field sort=stars \
            --raw-field order=desc \
            --raw-field per_page=50 \
            --jq '.items[].full_name' || true)

          if [ -z "$REPOS" ]; then
            RAW_Q="language:$LANG fork:false archived:false"
            REPOS=$(gh api -X GET /search/repositories \
              --raw-field q="$RAW_Q" \
              --raw-field sort=stars \
              --raw-field order=desc \
              --raw-field per_page=10 \
              --jq '.items[].full_name' || true)
          fi

          JSON_ARRAY=$(printf "%s\n" "$REPOS" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "repo_list=$JSON_ARRAY" >> $GITHUB_OUTPUT

  multi_scan:
    needs: fetch_top_repos
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJSON(needs.fetch_top_repos.outputs.repo_list) }}

    steps:

      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          repository: ${{ matrix.repo }}
          path: project-src

      - name: Detect language files
        id: detect_lang
        run: |
          LANG="${{ github.event.inputs.language }}"
          cd project-src

          case "$LANG" in
            python) PATTERN="-name '*.py'" ;;
            cpp) PATTERN="-name '*.cpp' -o -name '*.hpp' -o -name '*.h' -o -name '*.c'" ;;
            java) PATTERN="-name '*.java' -o -name '*.kt'" ;;
            javascript) PATTERN="-name '*.js' -o -name '*.ts'" ;;
            *) echo "has_lang=false" >> $GITHUB_OUTPUT; exit 0 ;;
          esac

          FILE_COUNT=$(find . -type f \( $PATTERN \) | wc -l)
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "has_lang=false" >> $GITHUB_OUTPUT
          else
            echo "has_lang=true" >> $GITHUB_OUTPUT
          fi

      - name: Skip repo if language not found
        if: steps.detect_lang.outputs.has_lang == 'false'
        run: echo "Skipping repo"

      - name: Initialize CodeQL
        if: steps.detect_lang.outputs.has_lang == 'true'
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ github.event.inputs.language }}

      - name: Analyze with CodeQL
        if: steps.detect_lang.outputs.has_lang == 'true'
        uses: github/codeql-action/analyze@v4
        continue-on-error: true

      - name: Install Semgrep
        if: steps.detect_lang.outputs.has_lang == 'true'
        run: |
          python3 -m pip install --upgrade pip
          pip install semgrep

      - name: Run Semgrep
        if: steps.detect_lang.outputs.has_lang == 'true'
        run: |
          mkdir -p project-src/semgrep_reports
          if ! semgrep --config=auto --json project-src > project-src/semgrep_reports/semgrep.json 2>/dev/null; then
            echo '{"results":[]}' > project-src/semgrep_reports/semgrep.json
          fi

      - name: Generate summary.csv
        if: steps.detect_lang.outputs.has_lang == 'true'
        run: |
          SUMMARY_DIR="project-src/scan_summary"
          mkdir -p "$SUMMARY_DIR"
          CSV_FILE="$SUMMARY_DIR/summary.csv"

          echo "repo,language,codeql_issues,semgrep_issues" > "$CSV_FILE"

          CODEQL_ISSUES=0
          for SARIF in $(find project-src -name "*.sarif" || true); do
            COUNT=$(jq '[.runs[].results[]] | length' "$SARIF" 2>/dev/null || echo 0)
            CODEQL_ISSUES=$((CODEQL_ISSUES + COUNT))
          done

          SEMGREP_FILE="project-src/semgrep_reports/semgrep.json"
          SEMGREP_ISSUES=$(jq '.results | length' "$SEMGREP_FILE" 2>/dev/null || echo 0)

          echo "${{ matrix.repo }},${{ github.event.inputs.language }},$CODEQL_ISSUES,$SEMGREP_ISSUES" >> "$CSV_FILE"

      - name: Upload artifact (summary only)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.repo }}-summary
          path: project-src/scan_summary/summary.csv

  aggregate_summaries:
    needs: multi_scan
    runs-on: ubuntu-latest
    steps:
      - name: Download all summary artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_summaries

      - name: Combine summaries
        run: |
          echo "repo,language,codeql_issues,semgrep_issues" > master_summary.csv

          found=0
          for f in $(find all_summaries -name "summary.csv"); do
            tail -n +2 "$f" >> master_summary.csv
            found=$((found+1))
          done

          echo "Summaries found: $found"

      - name: Upload master summary
        uses: actions/upload-artifact@v4
        with:
          name: master_summary
          path: master_summary.csv
